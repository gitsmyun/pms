# 작성일 2026 01 08
# 작업자 윤성민
# 설명 이 워크플로우는 기업형 저장소 운영을 위해 풀리퀘스트와 주요 브랜치 푸시에서 자동으로 검증을 수행한다
# 설명 변경 감지 기반으로 프론트와 백엔드 잡을 선택 실행하여 불필요한 실행을 줄인다
# 설명 백엔드는 자바 21 기준으로 그레이들 테스트와 빌드를 실행하여 컴파일 오류와 기본 품질을 확인한다
# 설명 프론트는 노드 20과 pnpm 고정 버전을 사용하며 잠금 파일 기반 설치로 재현 가능한 의존성 구성을 보장한다
# 설명 프론트 품질 게이트는 타입 체크와 번들 빌드를 분리하여 실패 원인 파악과 관리가 쉽도록 한다
# 설명 통합 테스트는 도커가 필요한 경우가 많으므로 기본 CI에서는 제외하고 별도 워크플로 또는 수동 실행으로 운영한다
# 설명 동시 실행 제어를 통해 같은 브랜치에서 중복 실행을 줄이고 최신 커밋 결과를 우선한다

name: CI

on:
  pull_request:
  push:
    branches:
      - main
      - develop

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Path filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'build.gradle.kts'
              - 'settings.gradle.kts'
              - 'gradle/**'
              - 'gradlew'
              - 'gradlew.bat'
            frontend:
              - 'frontend/**'

  backend:
    name: Backend (Gradle)
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend/pms-backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Test
        run: ./gradlew test

      - name: Build
        run: ./gradlew build

  frontend:
    name: Frontend (pnpm)
    needs: changes
    if: ${{ needs.changes.outputs.frontend == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Enable Corepack (pnpm)
        run: corepack enable

      - name: Activate pnpm version
        run: corepack prepare pnpm@10.27.0 --activate

      - name: Install (frozen)
        run: pnpm install --frozen-lockfile

      - name: Typecheck (vue-tsc)
        run: pnpm exec vue-tsc -b

      - name: Build (vite)
        run: pnpm exec vite build
