# 작성일 2026 01 08
# 작업자 윤성민
# 설명 이 워크플로우는 로컬 개발 시험 운영 배포 단계 중 개발에서 시험으로 시험에서 운영으로 승격을 수행하기 위한 수동 트리거 워크플로우이다
# 설명 동일 이미지 승격 원칙을 따르기 위해 입력받은 sha 태그를 기준으로 환경별 배포 기준 파일을 업데이트한다
# 설명 브랜치 룰셋에서 직접 push를 금지하므로 승격 변경은 별도 브랜치로 커밋하고 pull request를 생성하는 방식으로 운영한다
# 설명 시험과 운영 승격은 GitHub environments 승인 게이트를 통해 변경 통제와 감사 추적이 가능하도록 한다

name: Promote Image

on:
  workflow_dispatch:
    inputs:
      from_env:
        description: "source environment"
        required: true
        type: choice
        options:
          - dev
          - test
      to_env:
        description: "target environment"
        required: true
        type: choice
        options:
          - test
          - prod
      image_tag:
        description: "image tag to promote, example sha-abc123"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  promote:
    name: Promote metadata
    runs-on: ubuntu-latest
    environment: ${{ inputs.to_env }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate promotion flow
        run: |
          if [ "${{ inputs.from_env }}" = "dev" ] && [ "${{ inputs.to_env }}" != "test" ]; then
            echo "invalid promotion"; exit 1;
          fi
          if [ "${{ inputs.from_env }}" = "test" ] && [ "${{ inputs.to_env }}" != "prod" ]; then
            echo "invalid promotion"; exit 1;
          fi

      - name: Write promoted version file
        run: |
          mkdir -p k8s/manifests/${{ inputs.to_env }}
          echo "${{ inputs.image_tag }}" > k8s/manifests/${{ inputs.to_env }}/IMAGE_TAG

      - name: Create promotion branch
        id: branch
        run: |
          BRANCH="promote/${{ inputs.to_env }}/${{ inputs.image_tag }}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          git checkout -b "$BRANCH"

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add k8s/manifests/${{ inputs.to_env }}/IMAGE_TAG
          git commit -m "promote: ${{ inputs.image_tag }} to ${{ inputs.to_env }}"

      - name: Push promotion branch
        run: git push --set-upstream origin "${{ steps.branch.outputs.branch }}"

      - name: Create pull request
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner
            const repo = context.repo.repo

            const base = 'develop'
            const head = `${{ steps.branch.outputs.branch }}`

            const title = `promote: ${{ inputs.image_tag }} to ${{ inputs.to_env }}`
            const body = [
              '작성일 2026 01 08',
              '작업자 윤성민',
              '설명 이 풀리퀘스트는 동일 이미지 승격 원칙에 따라 환경별 배포 기준 파일을 업데이트한다',
              '설명 브랜치 룰셋으로 직접 푸시는 금지되어 있으므로 승격 변경은 풀리퀘스트로만 반영한다',
              `설명 from ${{ inputs.from_env }} to ${{ inputs.to_env }}`,
              `설명 image ${{ inputs.image_tag }}`
            ].join('\n')

            const existing = await github.paginate(github.rest.pulls.list, {
              owner,
              repo,
              state: 'open',
              head: `${owner}:${head}`,
              base,
              per_page: 100,
            })

            if (existing.length > 0) {
              core.info(`PR already exists: ${existing[0].html_url}`)
              return
            }

            const pr = await github.rest.pulls.create({
              owner,
              repo,
              title,
              head,
              base,
              body,
            })

            core.info(`Created PR: ${pr.data.html_url}`)
