# 작성일 2026 01 09
# 작업자 윤성민
# 설명 이 워크플로우는 로컬 개발 시험 운영 배포 단계 중 개발에서 시험으로 시험에서 운영으로 승격을 수행하기 위한 수동 트리거 워크플로우이다
# 설명 동일 이미지 승격 원칙을 따르기 위해 입력받은 sha 태그를 기준으로 환경별 배포 기준 파일을 업데이트한다
# 설명 브랜치 룰셋에서 직접 push를 금지하므로 승격 변경은 별도 브랜치로 커밋하고 사용자가 pull request를 생성하여 병합하는 방식으로 운영한다
# 설명 GitHub 설정에서 GitHub Actions 토큰이 pull request 생성 또는 승인 권한을 갖지 못하도록 막혀 있을 수 있으므로 이 워크플로우는 자동 pull request 생성 API 호출을 하지 않는다
# 설명 워크플로우가 원격 브랜치를 직접 push 하는 방식은 레포 규칙과 충돌할 수 있으므로 기본은 아티팩트로 패치 파일을 제공하고 사용자가 로컬에서 승격 브랜치와 PR을 생성하도록 한다
# 설명 시험과 운영 승격은 GitHub environments 승인 게이트를 통해 변경 통제와 감사 추적이 가능하도록 한다

name: Promote Image

on:
  workflow_dispatch:
    inputs:
      from_env:
        description: "source environment"
        required: true
        type: choice
        options:
          - dev
          - test
      to_env:
        description: "target environment"
        required: true
        type: choice
        options:
          - test
          - prod
      image_tag:
        description: "image tag to promote, example sha-abc123"
        required: true
        type: string

permissions:
  contents: read

jobs:
  promote:
    name: Promote metadata
    runs-on: ubuntu-latest
    environment: ${{ inputs.to_env }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate promotion flow
        run: |
          if [ "${{ inputs.from_env }}" = "dev" ] && [ "${{ inputs.to_env }}" != "test" ]; then
            echo "invalid promotion"; exit 1;
          fi
          if [ "${{ inputs.from_env }}" = "test" ] && [ "${{ inputs.to_env }}" != "prod" ]; then
            echo "invalid promotion"; exit 1;
          fi

      - name: Write promoted version file
        run: |
          mkdir -p k8s/manifests/${{ inputs.to_env }}
          echo "${{ inputs.image_tag }}" > k8s/manifests/${{ inputs.to_env }}/IMAGE_TAG

      - name: Create promotion commit
        run: |
          git checkout -b "tmp/promote/${{ inputs.to_env }}/${{ inputs.image_tag }}"
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add k8s/manifests/${{ inputs.to_env }}/IMAGE_TAG
          git commit -m "promote: ${{ inputs.image_tag }} to ${{ inputs.to_env }}"

      - name: Create patch artifact
        run: |
          mkdir -p out
          git format-patch -1 HEAD --stdout > out/promote-${{ inputs.to_env }}-${{ inputs.image_tag }}.patch

      - name: Upload patch
        uses: actions/upload-artifact@v4
        with:
          name: promote-${{ inputs.to_env }}-${{ inputs.image_tag }}
          path: out/promote-${{ inputs.to_env }}-${{ inputs.image_tag }}.patch

      - name: Print next steps
        run: |
          echo "작성일 2026 01 09"
          echo "작업자 윤성민"
          echo "설명 레포 규칙과 토큰 정책에 따라 GitHub Actions가 원격 브랜치를 push 하거나 pull request를 생성하지 못할 수 있으므로 패치 파일을 아티팩트로 제공한다"
          echo "설명 Actions 실행 결과의 Artifacts 에서 patch 파일을 내려받는다"
          echo "설명 로컬에서 develop 최신을 기준으로 새 브랜치를 만든다"
          echo "설명 git apply patch 파일로 변경을 적용하고 커밋한 뒤 원격에 push 한다"
          echo "설명 GitHub 웹에서 해당 브랜치에서 develop 로 pull request 를 생성하고 리뷰 후 병합한다"
