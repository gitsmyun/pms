# 작성일 2026 01 09
# 작업자 윤성민
# 설명 이 파일은 로컬 PC에서 test 환경을 절차 검증용으로 구성하기 위한 Docker Compose 파일이다
# 설명 dev 환경과 동일한 컨테이너 단위를 유지하되 포트와 볼륨 이름을 분리하여 동시에 실행할 수 있도록 한다
# 설명 이미지 태그는 BACKEND_TAG FRONTEND_TAG 로 주입하며 동일 이미지 승격 원칙을 검증할 수 있도록 한다
# 설명 향후 Kubernetes 전환 시에도 backend frontend db 단위를 유지하여 매니페스트 전환 변경을 최소화한다

services:
  postgres:
    image: postgres:18
    container_name: pms-test-postgres
    restart: unless-stopped
    ports:
      - "${DB_PORT_TEST:-6432}:5432"
    environment:
      POSTGRES_DB: ${POSTGRES_DB_TEST:-pms}
      POSTGRES_USER: ${POSTGRES_USER_TEST:-pms}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD_TEST:-pms}
    volumes:
      - postgres-test-data:/var/lib/postgresql/data

  backend:
    image: ${BACKEND_IMAGE:-ghcr.io/${REPO_OWNER:-gitsmyun}/pms-backend}:${BACKEND_TAG_TEST:-sha-latest}
    container_name: pms-test-backend
    restart: unless-stopped
    depends_on:
      - postgres
    ports:
      - "${BACKEND_PORT_TEST:-8180}:8080"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE_TEST:-test}
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL_TEST:-jdbc:postgresql://postgres:5432/pms}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME_TEST:-pms}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD_TEST:-pms}

  frontend:
    image: ${FRONTEND_IMAGE:-ghcr.io/${REPO_OWNER:-gitsmyun}/pms-frontend}:${FRONTEND_TAG_TEST:-sha-latest}
    container_name: pms-test-frontend
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "${FRONTEND_PORT_TEST:-8181}:80"

volumes:
  postgres-test-data:

